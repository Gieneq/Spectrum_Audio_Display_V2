/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2022 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
//https://community.st.com/s/article/configuring-dsp-libraries-on-stm32cubeide
#include <stdio.h>
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define INTERVAL 10000
#define TEST_SAMPLES_COUNT 1024
const float test_signal[TEST_SAMPLES_COUNT] = {0.0, 0.032470934092998505, -0.04552023112773895, 0.08845461905002594, -0.07385179400444031, 0.12041059136390686, -0.07326880842447281, 0.1209050640463829, -0.04123488441109657, 0.09250228106975555, 0.01479058526456356, 0.046949371695518494, 0.07972287386655807, 0.001442926935851574, 0.13564562797546387, -0.026836339384317398, 0.16750457882881165, -0.0261838361620903, 0.16789154708385468, 0.005908958148211241, 0.13939860463142395, 0.061957087367773056, 0.09379415214061737, 0.12686064839363098, 0.04828263074159622, 0.18270337581634521, 0.020036764442920685, 0.2144462615251541, 0.020739823579788208, 0.21470676362514496, 0.052872467786073685, 0.18610480427742004, 0.10892418771982193, 0.14042998850345612, 0.1737799495458603, 0.09489459544420242, 0.22952361404895782, 0.06666330248117447, 0.2611314654350281, 0.06739804148674011, 0.26124662160873413, 0.09955160319805145, 0.23251688480377197, 0.15558794140815735, 0.18675300478935242, 0.22037692368030548, 0.1411750316619873, 0.27600258588790894, 0.11293961107730865, 0.3074565529823303, 0.11368727684020996, 0.3074076771736145, 0.14584295451641083, 0.2785314917564392, 0.20184506475925446, 0.2326599806547165, 0.2665484547615051, 0.1870209127664566, 0.32203733921051025, 0.15876279771327972, 0.3533187806606293, 0.15950481593608856, 0.35308724641799927, 0.19164396822452545, 0.32404619455337524, 0.2475932091474533, 0.27804863452911377, 0.3121923804283142, 0.23233012855052948, 0.3675259053707123, 0.20403100550174713, 0.39861631393432617, 0.2047489732503891, 0.39818379282951355, 0.2368531972169876, 0.36895960569381714, 0.2927311360836029, 0.3228178918361664, 0.35720765590667725, 0.27700182795524597, 0.4123675227165222, 0.24864354729652405, 0.4432486593723297, 0.24931934475898743, 0.44259703159332275, 0.28137049078941345, 0.4131717383861542, 0.3371589481830597, 0.36686795949935913, 0.40149471163749695, 0.3209364712238312, 0.4564628005027771, 0.2925012409687042, 0.4871167540550232, 0.29311704635620117, 0.48622822761535645, 0.3250972032546997, 0.4565841257572174, 0.38077837228775024, 0.41010069847106934, 0.4449554979801178, 0.36403629183769226, 0.4997141361236572, 0.3355065882205963, 0.530123233795166, 0.3360448479652405, 0.5289803147315979, 0.36793655157089233, 0.49910008907318115, 0.4234928488731384, 0.4524197578430176, 0.4874939024448395, 0.40620529651641846, 0.5420256853103638, 0.3775639832019806, 0.5721727013587952, 0.37800756096839905, 0.5707582831382751, 0.4097936153411865, 0.5406249165534973, 0.46520790457725525, 0.4937308728694916, 0.5290157794952393, 0.44734954833984375, 0.583303689956665, 0.4185798466205597, 0.6131718158721924, 0.41891202330589294, 0.6114692091941833, 0.45057567954063416, 0.5810661911964417, 0.505831241607666, 0.533941924571991, 0.569429337978363, 0.4873773753643036, 0.6234567761421204, 0.45846301317214966, 0.6530295610427856, 0.45866745710372925, 0.6510224938392639, 0.4901924729347229, 0.620333731174469, 0.5452730655670166, 0.5729633569717407, 0.6086450815200806, 0.5261996984481812, 0.6623960733413696, 0.4971248209476471, 0.691657543182373, 0.49718570709228516, 0.6893302798271179, 0.528556227684021, 0.6583400964736938, 0.5834460854530334, 0.6107081174850464, 0.6465763449668884, 0.5637299418449402, 0.7000352144241333, 0.5344792008399963, 0.7289699912071228, 0.5343812704086304, 0.726307213306427, 0.5655820369720459, 0.6950006484985352, 0.6202658414840698, 0.6470920443534851, 0.6831392049789429, 0.599884569644928, 0.7362909317016602, 0.5704432129859924, 0.7648841142654419, 0.5701716542243958, 0.7618711590766907, 0.6011878848075867, 0.7302336096763611, 0.6556509733200073, 0.6820340752601624, 0.7182528972625732, 0.6345829963684082, 0.7710829973220825, 0.6049367785453796, 0.7993202209472656, 0.6044774055480957, 0.795943021774292, 0.6352949738502502, 0.7639604806900024, 0.6895232796669006, 0.7154562473297119, 0.7518396377563477, 0.6677478551864624, 0.804334282875061, 0.6378831267356873, 0.8322018980979919, 0.637222409248352, 0.8284469246864319, 0.667827844619751, 0.7961061596870422, 0.7218078970909119, 0.7472839951515198, 0.7838253378868103, 0.6993052363395691, 0.8359712362289429, 0.6692091226577759, 0.8634562492370605, 0.6683341264724731, 0.859310507774353, 0.6987144351005554, 0.8265988826751709, 0.7524334192276001, 0.7774463295936584, 0.8141392469406128, 0.7291848659515381, 0.8659238815307617, 0.6988449692726135, 0.8930137753486633, 0.6977434158325195, 0.8884652256965637, 0.727886438369751, 0.8553707003593445, 0.7813321948051453, 0.8058758974075317, 0.8427143692970276, 0.757319986820221, 0.8941258192062378, 0.7267247438430786, 0.9208090305328369, 0.7253850698471069, 0.9158461093902588, 0.7552793622016907, 0.8823574185371399, 0.8084403872489929, 0.8325092792510986, 0.8694876432418823, 0.7836479544639587, 0.9205147624015808, 0.7527864575386047, 0.9467802047729492, 0.751197874546051, 0.9413922429084778, 0.7808325290679932, 0.9074987769126892, 0.8336982727050781, 0.8572869896888733, 0.8943999409675598, 0.8081099987030029, 0.9450322985649109, 0.7769720554351807, 0.9708698391914368, 0.7751244306564331, 0.965046763420105, 0.8044895529747009, 0.9307387471199036, 0.8570499420166016, 0.8801535964012146, 0.9173962473869324, 0.8306514620780945, 0.9676241874694824, 0.799227774143219, 0.9930243492126465, 0.7971118092536926, 0.9867569208145142, 0.8261980414390564, 0.9520253539085388, 0.8784440159797668, 0.90105801820755, 0.9384258985519409, 0.8512220978736877, 0.9882405400276184, 0.8195039629936218, 1.0131946802139282, 0.8171111345291138, 1.006474494934082, 0.8459101319313049, 0.971311092376709, 0.8978332281112671, 0.9199535250663757, 0.9574424624443054, 0.8697758316993713, 1.006835699081421, 0.837755560874939, 1.0313359498977661, 0.8350781798362732, 1.0241553783416748, 0.863582193851471, 0.9885528087615967, 0.9151749014854431, 0.9367978572845459, 0.9744040966033936, 0.8862713575363159, 1.0233688354492188, 0.8539419174194336, 1.0474079847335815, 0.8509730696678162, 1.0397602319717407, 0.8791753053665161, 1.0037119388580322, 0.9304309487342834, 0.9515531063079834, 0.9892734885215759, 0.9006716012954712, 1.0378031730651855, 0.8680269122123718, 1.0613752603530884, 0.8647605180740356, 1.0532543659210205, 0.892655074596405, 1.0167545080184937, 0.9435677528381348, 0.9641863703727722, 1.002017855644226, 0.9129443764686584, 1.0501070022583008, 0.879979133605957, 1.0732066631317139, 0.8764100670814514, 1.0646075010299683, 0.9039918184280396, 1.027651309967041, 0.9545564651489258, 0.9746690988540649, 1.0126093626022339, 0.9230622053146362, 1.0602532625198364, 0.8897719979286194, 1.0828759670257568, 0.8858959078788757, 1.0737942457199097, 0.9131605625152588, 1.0363776683807373, 0.963373064994812, 0.9829776883125305, 1.0210247039794922, 0.9310021996498108, 1.068219542503357, 0.8973835110664368, 1.0903618335723877, 0.8931969404220581, 1.0807942152023315, 0.9201412200927734, 1.0429141521453857, 0.9699983596801758, 0.9890934228897095, 1.0272456407546997, 0.9367465972900391, 1.0739885568618774, 0.902796745300293, 1.0956474542617798, 0.8982971906661987, 1.0855916738510132, 0.924918532371521, 1.0472458600997925, 0.9744179248809814, 0.9930022954940796, 1.0312585830688477, 0.9402822256088257, 1.0775474309921265, 0.9059995412826538, 1.0987213850021362, 0.9011852145195007, 1.088175654411316, 0.9274820685386658, 1.0493627786636353, 0.9766222834587097, 0.9946953058242798, 1.033055067062378, 0.941601037979126, 1.0788887739181519, 0.9069845676422119, 1.099576711654663, 0.9018548130989075, 1.0885404348373413, 0.9278265237808228, 1.0492600202560425, 0.9766069054603577, 0.9941684007644653, 1.032631278038025, 0.9406998157501221, 1.0780096054077148, 0.9057496190071106, 1.0982115268707275, 0.9003045558929443, 1.0866849422454834, 0.9259512424468994, 1.0469374656677246, 0.974372148513794, 0.9914222955703735, 1.0299886465072632, 0.9375802874565125, 1.074912190437317, 0.9022972583770752, 1.0946290493011475, 0.8965378403663635, 1.082613229751587, 0.9218606948852539, 1.0424000024795532, 0.9699233174324036, 0.9864628314971924, 1.0251332521438599, 0.9322490096092224, 1.0696035623550415, 0.8966350555419922, 1.0888370275497437, 0.8905631899833679, 1.076333999633789, 0.9155641794204712, 1.035657286643982, 0.9632706046104431, 0.9793006777763367, 1.0180763006210327, 0.9247176647186279, 1.0620957612991333, 0.8887754082679749, 1.0808485746383667, 0.8823939561843872, 1.0678611993789673, 0.9070759415626526, 1.0267242193222046, 0.9544291496276855, 0.9699512720108032, 1.008833646774292, 0.9150025844573975, 1.0524057149887085, 0.8787356615066528, 1.0706813335418701, 0.8720482587814331, 1.0572134256362915, 0.8964150547981262, 1.0156199932098389, 0.9434189200401306, 0.9584351181983948, 0.9974262714385986, 0.9031251072883606, 1.0405550003051758, 0.8665379881858826, 1.0583579540252686, 0.8595491647720337, 1.0444141626358032, 0.883605420589447, 1.0023692846298218, 0.9302647113800049, 0.9447774887084961, 0.9838797450065613, 0.8891112804412842, 1.0265703201293945, 0.8522093296051025, 1.0439058542251587, 0.8449245691299438, 1.029491662979126, 0.868675708770752, 0.9870010614395142, 0.9149960875511169, 0.9290082454681396, 0.9682245254516602, 0.8729920387268066, 1.0104827880859375, 0.8357813954353333, 1.0273569822311401, 0.8282069563865662, 1.0124788284301758, 0.85165935754776, 0.9695491194725037, 0.8976472020149231, 0.9111620783805847, 0.950495719909668, 0.8548027873039246, 0.9923284649848938, 0.8172904849052429, 1.0087482929229736, 0.8094335198402405, 0.9934133291244507, 0.8325943946838379, 0.9500519037246704, 0.8782569766044617, 0.8912782669067383, 0.9307329654693604, 0.8345836997032166, 0.9721477627754211, 0.796777606010437, 0.9881211519241333, 0.7886460423469543, 0.9723373651504517, 0.8115233778953552, 0.9285524487495422, 0.8568688035011292, 0.869400680065155, 0.9089804887771606, 0.8123793005943298, 0.9499857425689697, 0.7742881774902344, 0.9655212163925171, 0.7658906579017639, 0.9492974877357483, 0.788493275642395, 0.9050981998443604, 0.8335304856300354, 0.8455774784088135, 0.8852868676185608, 0.7882387042045593, 0.9258918166160583, 0.7498719096183777, 0.9409987330436707, 0.741218090057373, 0.9243447184562683, 0.7635555863380432, 0.879740834236145, 0.8082941770553589, 0.8198611736297607, 0.8597050905227661, 0.7622151970863342, 0.8999196887016296, 0.7235829830169678, 0.9146082401275635, 0.7146830558776855, 0.8975343108177185, 0.7367658019065857, 0.8525364398956299, 0.7812162637710571, 0.7923086285591125, 0.8322922587394714, 0.734366238117218, 0.8721271753311157, 0.6954796314239502, 0.8864083290100098, 0.6863446831703186, 0.8689255714416504, 0.708183765411377, 0.8235450387001038, 0.7523572444915771, 0.762980580329895, 0.8031095862388611, 0.7047533988952637, 0.8425763249397278, 0.6656240820884705, 0.8564616441726685, 0.656265914440155, 0.838581919670105, 0.6778730750083923, 0.792830765247345, 0.7217814922332764, 0.731941819190979, 0.7722221612930298, 0.6734422445297241, 0.8113328218460083, 0.634082555770874, 0.8248347043991089, 0.6245135068893433, 0.8065705299377441, 0.6459013223648071, 0.7604613900184631, 0.6895572543144226, 0.6992608904838562, 0.7396988868713379, 0.640501856803894, 0.7784662842750549, 0.6009249687194824, 0.7915977239608765, 0.5911582112312317, 0.7729622721672058, 0.6123397946357727, 0.726508617401123, 0.6557563543319702, 0.6650100350379944, 0.7056123614311218, 0.6060051918029785, 0.7440499663352966, 0.5662247538566589, 0.7568244934082031, 0.5562739968299866, 0.7378316521644592, 0.5772631764411926, 0.6910474300384521, 0.6204542517662048, 0.6292649507522583, 0.6700385212898254, 0.5700286030769348, 0.7081603407859802, 0.5300588607788086, 0.7205923199653625, 0.5199385285377502, 0.7012564539909363, 0.5407496094703674, 0.6541563272476196, 0.58372962474823, 0.5921046137809753, 0.633056640625, 0.5326515436172485, 0.6708774566650391, 0.4925074875354767, 0.682981550693512, 0.4822324514389038, 0.6633177399635315, 0.5028803944587708, 0.6159167885780334, 0.5456644296646118, 0.5536112189292908, 0.5947492718696594, 0.49395689368247986, 0.6322841644287109, 0.45365390181541443, 0.644075870513916, 0.44323962926864624, 0.6240995526313782, 0.46373993158340454, 0.5764135122299194, 0.506343424320221, 0.5138699412345886, 0.5552016496658325, 0.4540301561355591, 0.592466413974762, 0.4135842025279999, 0.6039615273475647, 0.4030466675758362, 0.5836887955665588, 0.42341533303260803, 0.5357338786125183, 0.4658542573451996, 0.47296854853630066, 0.5145020484924316, 0.4129597544670105, 0.5515128374099731, 0.3723872900009155, 0.5627277493476868, 0.36174291372299194, 0.5421749949455261, 0.38199636340141296, 0.4939678907394409, 0.42428722977638245, 0.4309975802898407, 0.4727410674095154, 0.37083661556243896, 0.5095145106315613, 0.3301544785499573, 0.5204659700393677, 0.3194201588630676, 0.4996502697467804, 0.33957526087760925, 0.4512079656124115, 0.3817349374294281, 0.3880498707294464, 0.4300117790699005, 0.3277539908885956, 0.4665648937225342, 0.28697946667671204, 0.47727012634277344, 0.2761724293231964, 0.4562087059020996, 0.2962464392185211, 0.407548725605011, 0.3382922112941742, 0.3442203998565674, 0.38640937209129333, 0.2838072180747986, 0.42275962233543396, 0.2429579347372055, 0.43323609232902527, 0.2320958375930786, 0.41194668412208557, 0.25210633873939514, 0.3630867898464203, 0.29405584931373596, 0.29960617423057556, 0.34203097224235535, 0.239093616604805, 0.3781960606575012, 0.19818753004074097, 0.3884616792201996, 0.1872883141040802, 0.3669622838497162, 0.20725326240062714, 0.31792059540748596, 0.24912439286708832, 0.2543058395385742, 0.29697543382644653, 0.19371218979358673, 0.3329734206199646, 0.15276756882667542, 0.34304630756378174, 0.14184942841529846, 0.3213551640510559, 0.1617870032787323, 0.27215009927749634, 0.20359793305397034, 0.20841969549655914, 0.25134310126304626, 0.1477634310722351, 0.28719228506088257, 0.10679874569177628, 0.2970908284187317, 0.09588015079498291, 0.2752264738082886, 0.11580877751111984, 0.2258766144514084, 0.15757793188095093, 0.16204923391342163, 0.20523566007614136, 0.10134907066822052, 0.24095450341701508, 0.06038302183151245, 0.2506973147392273, 0.04948263615369797, 0.2286784052848816, 0.06942091882228851, 0.17920254170894623, 0.11116687208414078, 0.11529706418514252, 0.15875576436519623, 0.05457188934087753, 0.19436293840408325, 0.013623343780636787, 0.20396873354911804, 0.0027599739842116833, 0.18181414902210236, 0.022726671770215034, 0.13223125040531158, 0.064468152821064, 0.06826665252447128, 0.11200693994760513, 0.007535473443567753, 0.1475212275981903, -0.03337658569216728, 0.15700888633728027, -0.044184017926454544, 0.13473758101463318, -0.024170035496354103, 0.08506667613983154, 0.01758580096065998, 0.021062064915895462, 0.06509330868721008, -0.03965601697564125, 0.10053356736898422, -0.08051253110170364, 0.10992204397916794, -0.09124502539634705, 0.08755303919315338, -0.07116483151912689, 0.03781323879957199, -0.029375752434134483, -0.026212235912680626, 0.01811935007572174, -0.086898073554039, 0.05350450053811073, -0.1276799440383911, 0.06281275302171707, -0.13831846415996552, 0.04036512225866318, -0.11815311014652252, -0.009424454532563686, -0.07631189376115799, -0.07345163822174072, -0.02881031669676304, -0.13408608734607697, 0.006538630463182926, -0.17477421462535858, 0.015785638242959976, -0.18529975414276123, -0.0067215897142887115, -0.16503030061721802, -0.05654183775186539, -0.1231180801987648, -0.12055160105228424, -0.07559117674827576, -0.1811155527830124, -0.04025956615805626, -0.22169089317321777, -0.031054886057972908, -0.2320844978094101, -0.05360272526741028, -0.21169207990169525, -0.10343460738658905, -0.16969004273414612, -0.16740790009498596, -0.12211903929710388, -0.22788232564926147, -0.08678598701953888, -0.26832592487335205, -0.07760480791330338, -0.27856871485710144, -0.10017437487840652, -0.2580345571041107, -0.1499989777803421, -0.21592403948307037, -0.2139168381690979, -0.16829028725624084, -0.274282842874527, -0.13293713331222534, -0.3145758807659149, -0.12376076728105545, -0.3246491253376007, -0.14633332192897797, -0.3039546310901642, -0.1961318403482437, -0.2617170512676239, -0.25997552275657654, -0.2140020728111267, -0.3202143609523773, -0.17861033976078033, -0.36033815145492554, -0.1694202721118927, -0.37022334337234497, -0.19197724759578705, -0.3493500351905823, -0.24173112213611603, -0.3069671094417572, -0.30548202991485596, -0.2591525912284851, -0.3655751645565033, -0.2237040102481842, -0.4055112898349762, -0.21448193490505219, -0.41519007086753845, -0.23700501024723053, -0.3941197991371155, -0.2866958677768707, -0.3515733778476715, -0.35033565759658813, -0.30364128947257996, -0.410264790058136, -0.2681178152561188, -0.4499950706958771, -0.2588456869125366, -0.4594493806362152, -0.2813167870044708, -0.4381641745567322, -0.3309265673160553, -0.39543646574020386, -0.39443716406822205, -0.34736907482147217, -0.45418432354927063, -0.31175294518470764, -0.4936908483505249, -0.30241304636001587, -0.5029029250144958, -0.32481440901756287, -0.481385201215744, -0.37432533502578735, -0.438458651304245, -0.43768900632858276, -0.390238493680954, -0.4972364902496338, -0.35451236367225647, -0.5365017056465149, -0.3450872600078583, -0.545454204082489, -0.36740148067474365, -0.5236865878105164, -0.41679611802101135, -0.4805440902709961, -0.4799954891204834, -0.4321540892124176, -0.539326012134552, -0.39630088210105896, -0.5783327221870422, -0.38677358627319336, -0.587008535861969, -0.40898361802101135, -0.5649742484092712, -0.4582449197769165, -0.5215989947319031, -0.5212630033493042, -0.4730224609375, -0.5803596377372742, -0.4370255768299103, -0.6190910935401917, -0.42737942934036255, -0.6274735927581787, -0.4494686424732208, -0.6051561236381531, -0.49858006834983826, -0.5615318417549133, -0.561400294303894, -0.5127525329589844, -0.6202466487884521, -0.47659578919410706, -0.6586864590644836, -0.46681463718414307, -0.6667594909667969, -0.4887669086456299, -0.6441428661346436, -0.5377122759819031, -0.6002535820007324, -0.6003185510635376, -0.5512558221817017, -0.6588985919952393, -0.5149235129356384, -0.6970310211181641, -0.5049916505813599, -0.7047789096832275, -0.5267913341522217, -0.6818475723266602, -0.5755550265312195, -0.6376780271530151, -0.6379318237304688, -0.5884464979171753, -0.6962300539016724, -0.551923394203186, -0.7340397238731384, -0.5418257713317871, -0.7414473295211792, -0.5634576678276062, -0.7181863188743591, -0.6120245456695557, -0.6737216711044312, -0.6741567850112915, -0.6242417097091675, -0.732158362865448, -0.5875132083892822, -0.769630491733551, -0.5772351026535034, -0.7766832113265991, -0.5986846685409546, -0.7530781626701355, -0.6470402479171753, -0.7083041667938232, -0.7089135050773621, -0.6585615277290344, -0.7666040062904358, -0.621613621711731, -0.803724467754364, -0.6111410856246948, -0.8104082942008972, -0.6323943138122559, -0.7864453792572021, -0.6805246472358704, -0.7413483262062073, -0.7421250343322754, -0.6913295984268188, -0.7994908094406128, -0.6541487574577332, -0.8362459540367126, -0.6434683799743652, -0.842547595500946, -0.6645119786262512, -0.8182135224342346, -0.7124037742614746, -0.7727804780006409, -0.7737181186676025, -0.7224727869033813, -0.8307459950447083, -0.6850461959838867, -0.8671229481697083, -0.6741452813148499, -0.8730295896530151, -0.6949665546417236, -0.8483119606971741, -0.7426071166992188, -0.8025305271148682, -0.8036227822303772, -0.7519215941429138, -0.8603004217147827, -0.7142372131347656, -0.8962869644165039, -0.7031036615371704, -0.9017865657806396, -0.7236905097961426, -0.8766735196113586, -0.7710679173469543, -0.8305320143699646, -0.8317731618881226, -0.7796103358268738, -0.8880887627601624, -0.7416567206382751, -0.9236732721328735, -0.7302791476249695, -0.9287545680999756, -0.7506203055381775, -0.9032349586486816, -0.7977234125137329, -0.8567224740982056, -0.8581069707870483, -0.8054772019386292, -0.9140495657920837, -0.7672436833381653, -0.9492213129997253, -0.7556114792823792, -0.9538735747337341, -0.7756963968276978, -0.9279370307922363, -0.8225145936012268, -0.8810433745384216, -0.8825660943984985, -0.8294645547866821, -0.9381254315376282, -0.7909411191940308, -0.9728743433952332, -0.7790443897247314, -0.9770878553390503, -0.7988632321357727, -0.9507246613502502, -0.8453867435455322, -0.9034404158592224, -0.9050966501235962, -0.8515186905860901, -0.9602632522583008, -0.8126961588859558, -0.9945800304412842, -0.8005258440971375, -0.9983456134796143, -0.8200696110725403, -0.9715470671653748, -0.8662895560264587, -0.9238634705543518, -0.9256488680839539, -0.8715903759002686, -0.980414092540741, -0.8324604034423828, -1.0142902135849, -0.8200081586837769, -1.0175997018814087, -0.8392685651779175, -0.9903575778007507, -0.8851767778396606, -0.9422668814659119, -0.9441775679588318, -0.8896346688270569, -0.9985334277153015, -0.850189745426178, -1.03196120262146, -0.8374481201171875, -1.0348070859909058, -0.856417715549469, -1.007114291191101, -0.9020068049430847, -0.9586094617843628, -0.9606418609619141};

#define SAMPLES					TEST_SAMPLES_COUNT*2 	/* TEST_SAMPLES_COUNT real party and TEST_SAMPLES_COUNT imaginary parts */
#define FFT_SIZE				TEST_SAMPLES_COUNT		/* FFT size is always the same size as we have samples, so TEST_SAMPLES_COUNT in our case */

/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
 ADC_HandleTypeDef hadc1;
DMA_HandleTypeDef hdma_adc1;

UART_HandleTypeDef huart2;

/* USER CODE BEGIN PV */
int __io_putchar(int ch)
{
  if (ch == '\n') {
    __io_putchar('\r');
  }

  HAL_UART_Transmit(&huart2, (uint8_t*)&ch, 1, HAL_MAX_DELAY);

  return 1;
}

float32_t Input[SAMPLES];
float32_t Output[FFT_SIZE];
int led = 0;

void benchmark(){

	arm_cfft_radix4_instance_f32 S;	/* ARM CFFT module */
	float32_t maxValue;				/* Max FFT value is stored here */
	uint32_t maxIndex;				/* Index in Output array where max value is */
	int i = 0;

	for (i = 0; i < SAMPLES; i+=2) {
		/* Real part, make offset by ADC / 2 */
		Input[i] = (float32_t)(test_signal[i/2]);
	}

	for (i = 1; i < SAMPLES; i+=2) {
		/* Imaginary part */
		Input[i] = 0;
	}

	/* Initialize the CFFT/CIFFT module, intFlag = 0, doBitReverse = 1 */
	arm_cfft_radix4_init_f32(&S, FFT_SIZE, 0, 1);

	/* Process the data through the CFFT/CIFFT module */
	arm_cfft_radix4_f32(&S, Input);

	/* Process the data through the Complex Magniture Module for calculating the magnitude at each bin */
	arm_cmplx_mag_f32(Input, Output, FFT_SIZE);

	/* Calculates maxValue and returns corresponding value */
	arm_max_f32(Output, FFT_SIZE, &maxValue, &maxIndex);

	printf("START INPUT SIGNAL %d:\n", TEST_SAMPLES_COUNT);
	for (i = 0; i < TEST_SAMPLES_COUNT; i++) {
		printf("%f, ",  test_signal[i]);
	}
	printf("\n");
	printf("STOP INPUT SIGNAL\n\n");


	printf("START MAGNITUDES %d:\n", FFT_SIZE / 2);
	for (i = 0; i < FFT_SIZE / 2; i++) {
		printf("%f, ",  Output[i]);
	}
	printf("\n");
	printf("STOP MAGNITUDES\n\n");


	printf("START REAL %d:\n", SAMPLES / 2);
	for (i = 0; i < SAMPLES; i+=2) {
		printf("%f, ",  Input[i]);
	}
	printf("\n");
	printf("STOP REAL\n\n");


	printf("START IMAG %d:\n", SAMPLES / 2);
	for (i = 1; i < SAMPLES; i+=2) {
		printf("%f, ",  Input[i]);
	}
	printf("\n");
	printf("STOP IMAG\n\n");


	printf("START TEST, IT WILL TAKE %d MS...\n", INTERVAL);
	uint32_t start_millis = HAL_GetTick();
	float delta_millis = 0;
	int counter = 0;

	while(HAL_GetTick() - start_millis < INTERVAL) {
		/* Process the data through the CFFT/CIFFT module */
		arm_cfft_radix4_f32(&S, Input);

		/* Process the data through the Complex Magniture Module for calculating the magnitude at each bin */
		arm_cmplx_mag_f32(Input, Output, FFT_SIZE);

		/* Calculates maxValue and returns corresponding value */
		arm_max_f32(Output, FFT_SIZE, &maxValue, &maxIndex);
		++counter;
	}

	delta_millis = HAL_GetTick() - start_millis;
	printf("STOP TEST! DONE %d ITERATIONS AND WITH %d FFT POINTS GOT %d Hz, T = %d US.\n", counter, FFT_SIZE, (int)(counter*1000.0/delta_millis), (int)(delta_millis*1000.0/counter));

}



/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_DMA_Init(void);
static void MX_ADC1_Init(void);
static void MX_USART2_UART_Init(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

const float fs = 1.0 * 36e6/(601.5 + 12.5);

//HAL_ADC
/* ADC IRQHandler and Callbacks used in non-blocking modes (Interruption and DMA) */
//void                    HAL_ADC_IRQHandler(ADC_HandleTypeDef* hadc);
//void                    HAL_ADC_ConvCpltCallback(ADC_HandleTypeDef* hadc);
//void                    HAL_ADC_ConvHalfCpltCallback(ADC_HandleTypeDef* hadc);
//void                    HAL_ADC_LevelOutOfWindowCallback(ADC_HandleTypeDef* hadc);
//void                    HAL_ADC_ErrorCallback(ADC_HandleTypeDef *hadc);

/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_DMA_Init();
  MX_ADC1_Init();
  MX_USART2_UART_Init();
  /* USER CODE BEGIN 2 */

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  volatile static uint16_t value[2048];

  HAL_ADCEx_Calibration_Start(&hadc1, ADC_SINGLE_ENDED);
  HAL_ADC_Start_DMA(&hadc1, (uint32_t*)value, 2048);

  benchmark();

  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};
  RCC_PeriphCLKInitTypeDef PeriphClkInit = {0};

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI;
  RCC_OscInitStruct.HSIState = RCC_HSI_ON;
  RCC_OscInitStruct.HSICalibrationValue = RCC_HSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSI;
  RCC_OscInitStruct.PLL.PLLMUL = RCC_PLL_MUL16;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV2;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV8;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_2) != HAL_OK)
  {
    Error_Handler();
  }
  PeriphClkInit.PeriphClockSelection = RCC_PERIPHCLK_USART2|RCC_PERIPHCLK_ADC12;
  PeriphClkInit.Usart2ClockSelection = RCC_USART2CLKSOURCE_PCLK1;
  PeriphClkInit.Adc12ClockSelection = RCC_ADC12PLLCLK_DIV2;
  if (HAL_RCCEx_PeriphCLKConfig(&PeriphClkInit) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief ADC1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_ADC1_Init(void)
{

  /* USER CODE BEGIN ADC1_Init 0 */

  /* USER CODE END ADC1_Init 0 */

  ADC_MultiModeTypeDef multimode = {0};
  ADC_ChannelConfTypeDef sConfig = {0};

  /* USER CODE BEGIN ADC1_Init 1 */

  /* USER CODE END ADC1_Init 1 */

  /** Common config
  */
  hadc1.Instance = ADC1;
  hadc1.Init.ClockPrescaler = ADC_CLOCK_ASYNC_DIV1;
  hadc1.Init.Resolution = ADC_RESOLUTION_12B;
  hadc1.Init.ScanConvMode = ADC_SCAN_DISABLE;
  hadc1.Init.ContinuousConvMode = ENABLE;
  hadc1.Init.DiscontinuousConvMode = DISABLE;
  hadc1.Init.ExternalTrigConvEdge = ADC_EXTERNALTRIGCONVEDGE_NONE;
  hadc1.Init.ExternalTrigConv = ADC_SOFTWARE_START;
  hadc1.Init.DataAlign = ADC_DATAALIGN_RIGHT;
  hadc1.Init.NbrOfConversion = 1;
  hadc1.Init.DMAContinuousRequests = ENABLE;
  hadc1.Init.EOCSelection = ADC_EOC_SINGLE_CONV;
  hadc1.Init.LowPowerAutoWait = DISABLE;
  hadc1.Init.Overrun = ADC_OVR_DATA_OVERWRITTEN;
  if (HAL_ADC_Init(&hadc1) != HAL_OK)
  {
    Error_Handler();
  }

  /** Configure the ADC multi-mode
  */
  multimode.Mode = ADC_MODE_INDEPENDENT;
  if (HAL_ADCEx_MultiModeConfigChannel(&hadc1, &multimode) != HAL_OK)
  {
    Error_Handler();
  }

  /** Configure Regular Channel
  */
  sConfig.Channel = ADC_CHANNEL_1;
  sConfig.Rank = ADC_REGULAR_RANK_1;
  sConfig.SingleDiff = ADC_SINGLE_ENDED;
  sConfig.SamplingTime = ADC_SAMPLETIME_601CYCLES_5;
  sConfig.OffsetNumber = ADC_OFFSET_NONE;
  sConfig.Offset = 0;
  if (HAL_ADC_ConfigChannel(&hadc1, &sConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN ADC1_Init 2 */

  /* USER CODE END ADC1_Init 2 */

}

/**
  * @brief USART2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_USART2_UART_Init(void)
{

  /* USER CODE BEGIN USART2_Init 0 */

  /* USER CODE END USART2_Init 0 */

  /* USER CODE BEGIN USART2_Init 1 */

  /* USER CODE END USART2_Init 1 */
  huart2.Instance = USART2;
  huart2.Init.BaudRate = 115200;
  huart2.Init.WordLength = UART_WORDLENGTH_8B;
  huart2.Init.StopBits = UART_STOPBITS_1;
  huart2.Init.Parity = UART_PARITY_NONE;
  huart2.Init.Mode = UART_MODE_TX_RX;
  huart2.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  huart2.Init.OverSampling = UART_OVERSAMPLING_16;
  huart2.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE;
  huart2.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;
  if (HAL_UART_Init(&huart2) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN USART2_Init 2 */

  /* USER CODE END USART2_Init 2 */

}

/**
  * Enable DMA controller clock
  */
static void MX_DMA_Init(void)
{

  /* DMA controller clock enable */
  __HAL_RCC_DMA1_CLK_ENABLE();

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOA_CLK_ENABLE();

}

/* USER CODE BEGIN 4 */

/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
